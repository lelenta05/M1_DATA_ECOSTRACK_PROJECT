--CREATE DATABASE 

--CREATE DATABASE ecotrack_olap ;

--ACTIVATION DE L'EXTENSION POSTGIS 
CREATE EXTENSION IF NOT EXISTS postgis ;
SELECT POSTGIS_VERSION() ;

--CREATION DES DIMENSIONS 
CREATE TABLE IF NOT EXISTS DIM_TEMPS(
    temps_sk INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY ,
    date_complete DATE NOT NULL ,
    jour INTEGER GENERATED ALWAYS AS (EXTRACT (DAY FROM date_complete)) STORED ,
    mois INTEGER GENERATED ALWAYS AS (EXTRACT(MONTH FROM date_complete)) STORED ,
    trimestre INTEGER GENERATED ALWAYS AS (EXTRACT (QUARTER FROM date_complete)) STORED ,
    annee INTEGER GENERATED ALWAYS AS (EXTRACT(YEAR FROM date_complete)) STORED ,
    est_weekend BOOLEAN DEFAULT FALSE ,
    est_ferie BOOLEAN DEFAULT FALSE 
);

CREATE TABLE IF NOT EXISTS DIM_TYPE_DECHETS(
    type_dechet_sk INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY ,
    code_type_dechet VARCHAR(10) NOT NULL UNIQUE,
    name VARCHAR(20) NOT NULL ,
    description TEXT NULL,
    couleur VARCHAR(10),
    densite DECIMAL(5,2)
);
CREATE TABLE IF NOT EXISTS DIM_ZONES(
    zone_sk INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY ,
    zone_code VARCHAR(10) NOT NULL UNIQUE,
    type_zone VARCHAR(20) NOT NULL ,
    name VARCHAR(20) NOT NULL ,
    area_km2 DECIMAL(10,2) NOT NULL ,
    polygon GEOMETRY(Polygon,4326) NOT NULL
);
CREATE TABLE IF NOT EXISTS DIM_CONTAINERS(
    container_sk INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY ,
    container_code VARCHAR(10) NOT NULL UNIQUE ,
    container_type VARCHAR(20) NOT NULL ,
    capacity_l DECIMAL(5,2) NOT NULL ,
    install_date DATE NOT NULL ,
    location GEOMETRY(Point,4326) NOT NULL,--index
    ---SCD Type 2 : historique 
    date_debut DATE NULL ,
    date_fin DATE NULL ,
    version INTEGER DEFAULT 1,
    is_current BOOLEAN DEFAULT TRUE,
    --DENORMALISER 
    code_zone VARCHAR(10) NOT NULL ,
    code_type_dechet VARCHAR(10) NOT NULL 

);
CREATE TABLE IF NOT EXISTS DIM_CAPTEURS(
    capteur_sk INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY ,
    capteur_code VARCHAR(10) NOT NULL UNIQUE ,
    model VARCHAR(20) NOT NULL ,
    firmware_version  VARCHAR(20) NOT NULL,
    last_seen DATE NOT NULL ,
    container_code VARCHAR(10) NOT NULL 
);
CREATE TABLE IF NOT EXISTS DIM_VEHICULES(
    vehicule_sk INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY ,
    vehicule_code VARCHAR(10) NOT NULL UNIQUE ,
    registration_number VARCHAR(30) NOT NULL ,
    model VARCHAR(20) NOT NULL ,
    capacite DECIMAL(5,2) NOT NULL ,
    consommation DECIMAL(5,2) NOT NULL ,
    emission_co2_km DECIMAL(5,2) NOT NULL 
);

CREATE TABLE IF NOT EXISTS DIM_AGENTS(
    agent_sk INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY ,
    agent_code VARCHAR(10) NOT NULL UNIQUE ,
    firstname VARCHAR(20) NOT NULL ,
    lastname VARCHAR(20) NOT NULL ,
    is_active BOOLEAN DEFAULT TRUE NOT NULL,
    created_at TIMESTAMP NOT NULL 
);
CREATE TABLE IF NOT EXISTS DIM_TOURNEES(
    tournee_sk INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY ,
    tournee_code VARCHAR(10) NOT NULL UNIQUE ,
    quantity_kg DECIMAL(5,2) NOT NULL ,
    sequence INTEGER NOT NULL ,
    distance_m DECIMAL(5,2) NOT NULL ,
    duration_min DECIMAL(5,2) NOT NULL ,
    --denormalisation 
    agent_code VARCHAR(10) NOT NULL ,
    vehicule_code VARCHAR(10) NOT NULL ,
    zone_code VARCHAR(10) NOT NULL ,
    container_code VARCHAR(10) NOT NULL 
);

--CREATION DES FAITS
CREATE TABLE IF NOT EXISTS FAIT_MESURES(
	id_fm bigserial,
	temps_sk INTEGER NOT NULL ,
	container_sk INTEGER NOT NULL ,
    capteur_sk INTEGER NOT NULL ,
	zone_sk INTEGER NOT NULL ,
	type_dechet_sk INTEGER NOT NULL ,
	agent_sk INTEGER NOT NULL ,
    vehicule_sk INTEGER NOT NULL ,
	tournee_sk INTEGER NOT NULL ,
	taux_remplissage DECIMAL(5,2) NOT NULL ,
	volume_litres DECIMAL(5,2) NOT NULL ,
	temperatures DECIMAL(5,2) NOT NULL ,
	poids INTEGER NOT NULL ,
    is_overflow BOOLEAN NOT NULL,
    niveau_batterie INTEGER NOT NULL ,
	timestamp_mesure TIMESTAMP NOT NULL,
	qualite_signal VARCHAR(20) NULL ,
	PRIMARY KEY (id_fm,timestamp_mesure),--obligatoire de mettre timestamp_mesure dans la cle primaire pour le partitionnement
	CONSTRAINT fk_temps FOREIGN KEY (temps_sk) REFERENCES DIM_TEMPS(temps_sk),
	CONSTRAINT fk_container FOREIGN KEY(container_sk) REFERENCES DIM_CONTAINERS (container_sk),
    CONSTRAINT fk_capteur FOREIGN KEY(capteur_sk) REFERENCES DIM_CAPTEURS(capteur_sk),
    CONSTRAINT fk_zone FOREIGN KEY(zone_sk) REFERENCES DIM_ZONES(zone_sk),
    CONSTRAINT fk_type_dechet FOREIGN KEY(type_dechet_sk) REFERENCES DIM_TYPE_DECHETS(type_dechet_sk),
    CONSTRAINT fk_agent FOREIGN KEY(agent_sk) REFERENCES DIM_AGENTS(agent_sk),
    CONSTRAINT fk_vehicule FOREIGN KEY(vehicule_sk) REFERENCES DIM_VEHICULES(vehicule_sk),
    CONSTRAINT fk_tournee FOREIGN KEY(tournee_sk) REFERENCES DIM_TOURNEES(tournee_sk)

	)PARTITION BY RANGE(timestamp_mesure);


--CREATION DES DIFFERENTES TABLES DE PARTITION : 1ans donc 12 mois
CREATE TABLE fill_history_202401 PARTITION OF FAIT_MESURES FOR VALUES FROM ('2024-01-01 00:00:00') TO ('2024-02-01 00:00:00');
CREATE TABLE fill_history_202402 PARTITION OF FAIT_MESURES FOR VALUES FROM ('2024-02-01 00:00:00') TO ('2024-03-01 00:00:00');
CREATE TABLE fill_history_202403 PARTITION OF FAIT_MESURES FOR VALUES FROM ('2024-03-01 00:00:00') TO ('2024-04-01 00:00:00');
CREATE TABLE fill_history_202404 PARTITION OF FAIT_MESURES FOR VALUES FROM ('2024-04-01 00:00:00') TO ('2024-05-01 00:00:00');
CREATE TABLE fill_history_202405 PARTITION OF FAIT_MESURES FOR VALUES FROM('2024-05-01 00:00:00') TO ('2024-06-01 00:00:00');
CREATE TABLE fill_history_202406 PARTITION OF FAIT_MESURES FOR VALUES FROM ('2024-06-01 00:00:00') TO ('2024-07-01 00:00:00');
CREATE TABLE fill_history_202407 PARTITION OF FAIT_MESURES FOR VALUES FROM ('2024-07-01 00:00:00') TO ('2024-08-01 00:00:00');
CREATE TABLE fill_history_202408 PARTITION OF FAIT_MESURES FOR VALUES FROM ('2024-08-01 00:00:00') TO ('2024-09-01 00:00:00');
CREATE TABLE fill_history_202409 PARTITION OF FAIT_MESURES FOR VALUES FROM ('2024-09-01 00:00:00') TO ('2024-10-01 00:00:00');
CREATE TABLE fill_history_202410 PARTITION OF FAIT_MESURES FOR VALUES FROM ('2024-10-01 00:00:00') TO ('2024-11-01 00:00:00');
CREATE TABLE fill_history_202411 PARTITION OF FAIT_MESURES FOR VALUES FROM ('2024-11-01 00:00:00') TO ('2024-12-01 00:00:00');
CREATE TABLE fill_history_202412 PARTITION OF FAIT_MESURES FOR VALUES FROM ('2024-12-01 00:00:00') TO ('2025-01-01 00:00:00');

--CREATION DES INDEXES 
--INDEX SPATIAL GIST
CREATE INDEX idx_zone_polygon ON DIM_ZONES USING GIST (polygon);
CREATE INDEX idx_containeur_location ON DIM_CONTAINERS USING GIST(location);

--INDEX SUR LES COLONNES TEMPORELLES 
CREATE INDEX idx_temps_date_complete ON DIM_TEMPS (date_complete);
CREATE INDEX idx_container_install_date ON DIM_CONTAINERS(install_date);
CREATE INDEX idx_capteur_last_seen ON DIM_CAPTEURS(last_seen);
CREATE INDEX idx_agent_created_at ON DIM_AGENTS(created_at);

--INDEX SUR L'ID DE LA DATE POUR TROUVE TRES VITE LES MESURES EN UNE DATE DONNEE et AVEC L'ID DE LA DIM_TEMPS
CREATE INDEX idx_fait_temps ON FAIT_MESURES(temps_sk) ;
--CETTE INDEX COUVRE NON SEULEMENT LA COLONNE TMESTAMP_MESURE DANS LA TABLE DE FAIT_MESURE MAIS AUSSI POUR LES PARTITIONS : Index sur table parent (se propage aux partitions)
CREATE INDEX idx_fait_timestamp ON FAIT_MESURES(timestamp_mesure) ;
CREATE INDEX idx_fait_container ON FAIT_MESURES (container_sk);
CREATE INDEX idx_fait_zone ON FAIT_MESURES (zone_sk);
CREATE INDEX idx_fait_tournee ON FAIT_MESURES (tournee_sk);


--STATISTIQUES_QUOTIDIENNES_AGRÉGÉES
CREATE TABLE IF NOT EXISTS AGGREGATED_DAILY_STATS (
	stat_sk INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY ,
    zone_sk INTEGER NOT NULL ,
    temps_sk INTEGER NOT NULL,
	nb_mesures_total BIGINT NOT NULL ,
	taux_moyen DECIMAL(5,2) NOT NULL ,
	temperature_moyenne DECIMAL(5,2) NOT NULL ,
	nb_conteneurs_actifs INTEGER NOT NULL ,
	taux_remplissage_moyenne DECIMAL(5,2),
	CONSTRAINT fk_zone FOREIGN KEY(zone_sk) REFERENCES DIM_ZONES(zone_sk),
    CONSTRAINT fk_temps FOREIGN KEY(temps_sk) REFERENCES DIM_TEMPS(temps_sk)
);

--PREDICTION MACHINE LEARNING 
CREATE TABLE IF NOT EXISTS ML_PREDICTIONS (
	ml_sk INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY ,
	container_sk INTEGER NOT NULL ,
	date_prediction DATE NOT NULL ,
	taux_remplissage_prediction DECIMAL(8,4) NOT NULL ,
	confiance_prediction DECIMAL(5,2) NOT NULL ,
	modele_utilise VARCHAR(50) NOT NULL ,
	date_calcul  DATE NOT NULL,
	CONSTRAINT fk_container FOREIGN KEY(container_sk) REFERENCES DIM_CONTAINERS(container_sk)
);

--CREATION DE SES INDEX 
CREATE INDEX idx_date ON ML_PREDICTIONS (date_prediction,date_calcul) ; 
CREATE INDEX idx_pd_container ON ML_PREDICTIONS(container_sk) ;
CREATE INDEX idx_temps_ads ON AGGREGATED_DAILY_STATS (temps_sk) ;
CREATE INDEX idx_zone_ads ON AGGREGATED_DAILY_STATS (zone_sk) ;



